{% extends "base.html" %}

{% block title %}Treino #{{ treino.id }} - Daily Trainer{% endblock %}

{% block extra_css %}
{{ super() }}
<style>
  .table-sm-badges .badge { font-weight: 600; }
  .card h2 small { font-size: 0.85rem; }
</style>
{% endblock %}

{% block content %}
<div class="mb-3 d-flex align-items-center gap-2">
    <a href="/web/treinos" class="btn btn-sm btn-secondary">&larr; Voltar</a>
    <div>
        <h1 class="h5 mb-0">Treino #{{ treino.id }}</h1>
        <small class="text-muted">Aluno {{ treino.aluno_nome }} (ID {{ treino.aluno_id }}) &bull; {{ treino.data }}</small>
    </div>
</div>

<div class="row g-3">
    <div class="col-lg-5">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h2 class="h6 text-uppercase text-muted">Resumo do treino</h2>
                <p class="mb-1"><strong>Data:</strong> {{ treino.data }}</p>
                <p class="mb-2"><strong>Observacoes:</strong> {{ treino.observacoes or "-" }}</p>
                <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                    <span class="badge bg-success-subtle text-success-emphasis border border-success-subtle">
                        {{ total_exercicios }} exercicio{{ total_exercicios != 1 and 's' or '' }}
                    </span>
                    {% for grupo, qtde in grupos_resumo.items() %}
                        <span class="badge bg-primary-subtle text-primary-emphasis border border-primary-subtle">
                            {{ grupo }} &#x2022; {{ qtde }}
                        </span>
                    {% endfor %}
                    {% if not grupos_resumo %}
                        <span class="text-muted small">Sem exercicios ainda.</span>
                    {% endif %}
                </div>
                <button
                  type="button"
                  class="btn btn-outline-primary btn-sm"
                  id="btnEditarTreinoCard"
                  data-treino-id="{{ treino.id }}"
                  data-aluno-id="{{ treino.aluno_id }}"
                  data-data="{{ treino.data }}"
                  data-observacoes="{{ treino.observacoes|default('', true) }}"
                >
                    Editar treino
                </button>
            </div>
        </div>
    </div>

    <div class="col-lg-7">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h2 class="h6 text-uppercase text-muted">Adicionar exercicios</h2>
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="border rounded p-3 h-100">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-semibold">Padrao por grupo</span>
                            </div>
                            <form class="row g-2"
                                  method="post"
                                  action="/web/treinos/{{ treino.id }}/exercicios/adicionar_padrao">
                                <div class="col-12">
                                    <label class="form-label" for="grupoPadraoSelect">Grupo muscular</label>
                                    {% if grupos_padrao %}
                                    <select
                                        class="form-select"
                                        name="grupo_muscular"
                                        id="grupoPadraoSelect"
                                        required
                                    >
                                        <option value="" disabled selected>Selecione um grupo</option>
                                        {% for grupo in grupos_padrao %}
                                            <option value="{{ grupo }}">{{ grupo|capitalize }}</option>
                                        {% endfor %}
                                    </select>
                                    {% else %}
                                        <div class="alert alert-warning mb-0 py-2">
                                            Nenhum grupo muscular com exercicios padrão para o gênero do aluno.
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-12">
                                    <select name="perfil" class="form-select">
                                        {% for p in perfis %}
                                            <option value="{{ p }}">{{ p|capitalize }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-12 d-grid">
                                    <button type="submit" class="btn btn-outline-primary btn-sm" {% if not grupos_padrao %}disabled{% endif %}>
                                        Adicionar padroes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="border rounded p-3 h-100">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-semibold">Do catalogo</span>
                            </div>
                            <form class="row g-2"
                                  method="post"
                                  action="/web/treinos/{{ treino.id }}/exercicios/adicionar">
                                <div class="col-12">
                                    <select name="exercicio_id" class="form-select" required>
                                        <option value="" disabled selected>Selecione</option>
                                        {% for ex in exercicios_catalogo %}
                                            <option value="{{ ex.id }}">
                                                {{ ex.nome }}{% if ex.apelido %} ({{ ex.apelido }}){% endif %} - {{ ex.grupo_muscular or '-' }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-6">
                                    <input type="number" name="series" class="form-control" placeholder="Series" min="1" required>
                                </div>
                                <div class="col-6">
                                    <input type="number" name="repeticoes" class="form-control" placeholder="Reps" min="1" required>
                                </div>
                                <div class="col-12">
                                    <input type="number" step="0.01" name="carga" class="form-control" placeholder="Carga (kg)">
                                </div>
                                <div class="col-12">
                                    <textarea name="observacoes" rows="2" class="form-control" placeholder="Observacoes (opcional)"></textarea>
                                </div>
                                <div class="col-12 text-end">
                                    <button type="submit" class="btn btn-primary btn-sm">
                                        Adicionar exercicio
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<hr class="my-4">

<div class="d-flex justify-content-between align-items-center mb-2">
    <h3 class="h5 mb-0">Exercicios deste treino</h3>
    <small class="text-muted">{{ total_exercicios }} registr{{ total_exercicios == 1 and 'o' or 'os' }}</small>
    </div>

{% if exercicios_treino %}
<div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
            <tr>
                <th style="width: 40px;">#</th>
                <th>Exercicio</th>
                <th>Series x Reps</th>
                <th>Carga</th>
                <th>Observacoes</th>
                <th style="width: 180px;">Acoes</th>
            </tr>
        </thead>
        <tbody>
        {% for e in exercicios_treino %}
            <tr>
                <td>{{ e.ordem }}</td>
                <td>
                    <strong>{{ e.nome }}</strong>
                    {% if e.apelido %}
                        <br><small class="text-muted">{{ e.apelido }}</small>
                    {% endif %}
                    <br><span class="badge bg-primary-subtle text-primary-emphasis border border-primary-subtle">{{ e.grupo_muscular or "Sem grupo" }}</span>
                </td>
                <td>{{ e.series }} x {{ e.repeticoes }}</td>
                <td>
                        {% if e.carga is not none %}
                            {{ e.carga }} kg
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="text-truncate" style="max-width: 260px;">
                        {{ e.observacoes or "-" }}
                    </td>
                    <td>
                        <div class="d-flex flex-column gap-1">
                            <div class="d-flex gap-1">
                                <form method="post"
                                      action="/web/treinos/{{ treino.id }}/exercicios/{{ e.id }}/mover">
                                    <input type="hidden" name="direcao" value="up">
                                    <button type="submit" class="btn btn-sm btn-outline-secondary" title="Mover para cima">
                                        &uarr;
                                    </button>
                                </form>
                                <form method="post"
                                      action="/web/treinos/{{ treino.id }}/exercicios/{{ e.id }}/mover">
                                    <input type="hidden" name="direcao" value="down">
                                    <button type="submit" class="btn btn-sm btn-outline-secondary" title="Mover para baixo">
                                        &darr;
                                    </button>
                                </form>
                                <button
                                  type="button"
                                  class="btn btn-sm btn-outline-primary btn-editar-exercicio"
                                  title="Editar exercicio"
                                  data-exercicio-id="{{ e.id }}"
                                  data-series="{{ e.series }}"
                                  data-repeticoes="{{ e.repeticoes }}"
                                  data-carga="{{ e.carga }}"
                                  data-observacoes="{{ e.observacoes }}"
                                  data-nome="{{ e.nome }}"
                                >
                                    Editar
                                </button>
                            </div>
                            <form method="post"
                                  action="/web/treinos/{{ treino.id }}/exercicios/{{ e.id }}/deletar"
                                  onsubmit="return confirm('Remover este exercicio do treino?');">
                                <button type="submit" class="btn btn-sm btn-outline-danger w-100">
                                Remover
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="alert alert-info">
    Este treino ainda nao possui exercicios. Use os formularios acima para adicionar.
</div>
{% endif %}

<!-- Modal editar treino -->
<div class="modal fade" id="modalEditarTreino" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Editar treino</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <form id="formEditarTreino" method="post">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label" for="modalIdTreino">ID</label>
            <input type="text" class="form-control" id="modalIdTreino" value="" disabled>
          </div>
          <div class="mb-3">
            <label class="form-label" for="modalAlunoId">Aluno</label>
            <select class="form-select" name="aluno_id" id="modalAlunoId" required>
              {% for aluno in alunos_lista %}
                <option value="{{ aluno.id }}">{{ aluno.nome }} (ID {{ aluno.id }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label" for="modalData">Data</label>
            <input type="date" class="form-control" name="data" id="modalData" required>
          </div>
          <div class="mb-3">
            <label class="form-label" for="modalObsTreino">Observacoes</label>
            <textarea class="form-control" name="observacoes" id="modalObsTreino" rows="3" placeholder="Observacoes do treino"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal editar exercicio do treino -->
<div class="modal fade" id="modalEditarExercicio" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Editar exercicio</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <form id="formEditarExercicio" method="post">
        <div class="modal-body">
          <div class="mb-2">
            <strong id="modalExNome"></strong>
          </div>
          <div class="mb-3">
            <label class="form-label" for="modalExId">ID</label>
            <input type="text" class="form-control" id="modalExId" value="" disabled>
          </div>
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label" for="modalSeries">Series</label>
              <input type="number" min="1" class="form-control" name="series" id="modalSeries" required>
            </div>
            <div class="col-md-4">
              <label class="form-label" for="modalRepeticoes">Repeticoes</label>
              <input type="number" min="1" class="form-control" name="repeticoes" id="modalRepeticoes" required>
            </div>
            <div class="col-md-4">
              <label class="form-label" for="modalCarga">Carga (kg)</label>
              <input type="number" step="0.01" class="form-control" name="carga" id="modalCarga">
            </div>
          </div>
          <div class="mt-3">
            <label class="form-label" for="modalObs">Observacoes</label>
            <textarea class="form-control" name="observacoes" id="modalObs" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Modal editar treino
    var modalTreino = document.getElementById('modalEditarTreino');
    var formTreino = document.getElementById('formEditarTreino');
    var alunoTreino = document.getElementById('modalAlunoId');
    var dataTreino = document.getElementById('modalData');
    var obsTreino = document.getElementById('modalObsTreino');
    var idTreino = document.getElementById('modalIdTreino');
    function bindEditarTreino(btn) {
      if (!btn) return;
      btn.addEventListener('click', function() {
        var treinoId = btn.getAttribute('data-treino-id');
        var alunoId = btn.getAttribute('data-aluno-id');
        var dataVal = btn.getAttribute('data-data');
        var obsVal = btn.getAttribute('data-observacoes') || '';

        idTreino.value = treinoId;
        formTreino.setAttribute('action', '/web/treinos/' + treinoId + '/editar');
        alunoTreino.value = alunoId;
        dataTreino.value = dataVal;
        obsTreino.value = obsVal;

        var modal = bootstrap.Modal.getOrCreateInstance(modalTreino);
        modal.show();
      });
    }
    bindEditarTreino(document.getElementById('btnEditarTreino'));
    bindEditarTreino(document.getElementById('btnEditarTreinoCard'));

    var modalEditar = document.getElementById('modalEditarExercicio');
    var formEditar = document.getElementById('formEditarExercicio');
    var seriesInput = document.getElementById('modalSeries');
    var repsInput = document.getElementById('modalRepeticoes');
    var cargaInput = document.getElementById('modalCarga');
    var obsInput = document.getElementById('modalObs');
    var nomeLabel = document.getElementById('modalExNome');
    var idExInput = document.getElementById('modalExId');

    document.querySelectorAll('.btn-editar-exercicio').forEach(function(btn){
      btn.addEventListener('click', function(ev){
        ev.preventDefault();
        var exId = btn.getAttribute('data-exercicio-id');
        var series = btn.getAttribute('data-series') || '';
        var reps = btn.getAttribute('data-repeticoes') || '';
        var carga = btn.getAttribute('data-carga') || '';
        var obs = btn.getAttribute('data-observacoes') || '';
        var nome = btn.getAttribute('data-nome') || '';

        idExInput.value = exId;
        formEditar.setAttribute('action', '/web/treinos/{{ treino.id }}/exercicios/' + exId + '/editar');
        seriesInput.value = series;
        repsInput.value = reps;
        cargaInput.value = carga;
        obsInput.value = obs;
        nomeLabel.textContent = nome || 'Exercicio';

        var modal = bootstrap.Modal.getOrCreateInstance(modalEditar);
        modal.show();
      });
    });
  });
</script>
{% endblock %}
